/*! Menu Hotkeys - v0.1.0 - 2015-11-10
* https://github.com/jonmbake/menu-hotkeys
* Copyright (c) 2015 Jon Bake; Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["jquery"],b):b(a.jQuery)}(this,function(a){function b(a){if("string"==typeof a.data&&(a.data={keys:a.data}),a.data&&a.data.keys&&"string"==typeof a.data.keys){var b=a.handler,d=a.data.keys.toLowerCase().split(" ");a.handler=function(a){if(this===a.target||!(c.hotkeys.options.filterInputAcceptingElements&&c.hotkeys.textInputTypes.test(a.target.nodeName)||c.hotkeys.options.filterContentEditable&&c(a.target).attr("contenteditable")||c.hotkeys.options.filterTextInputs&&c.inArray(a.target.type,c.hotkeys.textAcceptingInputTypes)>-1)){var e="keypress"!==a.type&&c.hotkeys.specialKeys[a.which],f=String.fromCharCode(a.which).toLowerCase(),g="",h={};c.each(["alt","ctrl","shift"],function(b,c){a[c+"Key"]&&e!==c&&(g+=c+"+")}),a.metaKey&&!a.ctrlKey&&"meta"!==e&&(g+="meta+"),a.metaKey&&"meta"!==e&&g.indexOf("alt+ctrl+shift+")>-1&&(g=g.replace("alt+ctrl+shift+","hyper+")),e?h[g+e]=!0:(h[g+f]=!0,h[g+c.hotkeys.shiftNums[f]]=!0,"shift+"===g&&(h[c.hotkeys.shiftNums[f]]=!0));for(var i=0,j=d.length;j>i;i++)if(h[d[i]])return b.apply(this,arguments)}}}}var c=a,d={hotkeyPrefix:"alt"},e=function(){this.reset()};a.extend(e.prototype,{reset:function(){this.registered={}},register:function(a,b,c){b=Array.isArray(b)?b:[b],b.forEach(function(b){this.registered.hasOwnProperty(b)?this.registered[b].push({element:a,callback:c}):this.registered[b]=[{element:a,callback:c}]},this)},unregister:function(a,b){b=b?Array.isArray(b)?b:[b]:Object.keys(this.registered),b.forEach(function(b){var c=this.registered[b];if(c){for(var d=-1,e=0;e<c.length;e++)if(a.is(c[e].element)){d=e;break}-1!==d&&c.splice(d,1)}},this)},trigger:function(a){var b=this.registered[a];if(b){var c=Array.prototype.slice.call(arguments,1);b.forEach(function(b){b.element.trigger(a,c),b.callback&&b.callback.apply(null,c)})}}});var f=function(b){this.menuItem=b;var c=this.menuItem.$a;this.menuItem.hotkeyDispatcher.register(c,"menu-hotkey-input-error",function(b){a(".hotkey-error-msg").text(b).show(),a(".hotkey-input").focus()}),this.menuItem.hotkeyDispatcher.register(c,"menu-hotkey-input-close",this.close.bind(this)),this.menuItem.hotkeyDispatcher.register(c,"menu-hotkey-input-open")};a.extend(f.prototype,{close:function(){this.menuItem.$a.popover("destroy")},open:function(){var b=this.menuItem,c=b.$a;b.hotkeyDispatcher.trigger("menu-hotkey-input-close"),c.popover({animation:!1,placement:"bottom",html:!0,title:"Add a Hotkey",content:'<div class="alert alert-danger hotkey-error-msg" style="margin-bottom: 10px; display: none; font-size: 12px;"></div><div class="input-group input-group-sm input-prepend input-append" style="margin-bottom: 10px;"><span class="input-group-addon add-on" id="sizing-addon3">'+this.menuItem.hotkeyPrefix+'+</span>          <input type="text" class="input-sm input-small hotkey-input" size="1" maxlength="1"></div>          <button class="confirm btn btn-xs btn-mini btn-danger add-shortcut-btn">Add</button>          <button class="unconfirm btn btn-xs btn-mini cancel-shortcut-btn">Cancel</button>'}),c.popover("show"),a(".popover-title").css({"white-space":"nowrap"}),b.hotkey&&a(".hotkey-input").val(b.hotkey),a(".cancel-shortcut-btn").on("click",function(){b.hotkeyDispatcher.trigger("menu-hotkey-input-close")}),a(".add-shortcut-btn").on("click",function(){var c=a(".hotkey-input").val();this.validateHotkeyInput(c)&&b.hotkeyDispatcher.trigger("update-menu-shortcut",{name:b.name,hotkey:c})}.bind(this)),a(".hotkey-input").focus(),b.hotkeyDispatcher.trigger("menu-hotkey-input-open")},validateHotkeyInput:function(a){return 0===a.length?(this.menuItem.hotkeyDispatcher.trigger("menu-hotkey-input-error","Please enter a Shortcut value."),!1):a.length>1?(this.menuItem.hotkeyDispatcher.trigger("menu-hotkey-input-error","Shortcut must be one character long."),!1):a===this.menuItem.hotkey?(this.menuItem.hotkeyDispatcher.trigger("menu-hotkey-input-error","Value has not changed."),!1):!0}});var g=function(b,c,d,e){a.extend(this,{$a:b,hotkeyDispatcher:c,hotkeyPrefix:d}),this.name=b.text(),this.linkClicker=function(){var a=b[0];a&&a.click()},c.register(b,"menu-hotkey-updated",function(a){a.name===this.name&&(this.updateHotkey(a.hotkey),c.trigger("menu-hotkey-input-close"))}.bind(this)),this.updateHotkey(e),this.boundClickHandler=this.clickHandler.bind(this),this.$a.on("click",this.boundClickHandler)};a.extend(g.prototype,{destroy:function(){this.hotkeyDispatcher.trigger("menu-hotkey-input-close"),this.removeHotkeyIndicator(),this.hotkeyDispatcher.unregister(this.$a),this.hotkey&&a(document).unbind("keydown",this.linkClicker),this.$a.off("click",this.boundClickHandler)},clickHandler:function(a){3===a.which&&(a.preventDefault(),a.stopImmediatePropagation(),this.hotkeyPrompt=this.hotkeyPrompt||new f(this),this.hotkeyPrompt.open())},updateHotkey:function(b){if(b){this.hotkey&&a(document).unbind("keydown",this.linkClicker),this.hotkey=b,this.addHotkeyIndicator(b);var c=this.hotkeyPrefix+"+"+b;a(document).bind("keydown",c,this.linkClicker)}},addHotkeyIndicator:function(b){this.removeHotkeyIndicator(),this.$a.append(a("<sup>").text(b))},removeHotkeyIndicator:function(){this.$a.find("sup").remove()}});var h=function(b,c){a.extend(this,{$menu:b},d,c),this.init()};a.extend(h.prototype,{LOCAL_STORAGE_ITEM_NAME:"MENU_SHORTCUTS",init:function(){var b=this.$menu;this.menuItems&&this.menuItems.forEach(function(a){a.destroy()});var c=this.menuItems=[],d=this.hotkeyPrefix,f=this.dispatcher=new e;f.register(b,"update-menu-shortcut",this.saveShortcut.bind(this)),f.register(b,["menu-hotkey-input-open","menu-hotkey-input-close","menu-hotkey-input-error"]),this.loadSavedShortcuts().then(function(e){b.find("a").each(function(){var b=a(this);for(var h in e)if(h===b.text())return void c.push(new g(b,f,d,e[h]));c.push(new g(b,f,d))}),b.trigger("menu-hotkeys-loaded",e)})},saveShortcut:function(b){var c=this.getNameForHotkey(b.hotkey);return c?void this.dispatcher.trigger("menu-hotkey-input-error","Shortcut already exists for "+c+"."):void(this.menuHotkeyUrl?a.ajax({dataType:"json",method:"PUT",url:this.menuHotkeyUrl+"/"+encodeURI(b.name),data:b,success:function(){this.shortcuts[b.name]=b.hotkey,this.dispatcher.trigger("menu-hotkey-updated",b)}.bind(this)}):(this.shortcuts[b.name]=b.hotkey,window.localStorage.setItem(this.LOCAL_STORAGE_ITEM_NAME,JSON.stringify(this.shortcuts)),this.dispatcher.trigger("menu-hotkey-updated",b)))},loadSavedShortcuts:function(){if(this.shortcuts={},this.menuHotkeyUrl)return a.ajax({dataType:"json",url:this.menuHotkeyUrl,success:function(a){this.shortcuts=a}.bind(this)});var b=a.Deferred(),c=window.localStorage.getItem(this.LOCAL_STORAGE_ITEM_NAME);if(c)try{this.shortcuts=JSON.parse(c)}catch(d){return b.reject("Error while attempting to load menu shortcuts.  Unable to parse: ",c)}return b.resolve(this.shortcuts)},getNameForHotkey:function(a){for(var b in this.shortcuts)if(this.shortcuts[b]===a)return b}});var i={init:function(a){var b=this.data("hotkeys");return b?b.init():(b=new h(this,a),this.data("hotkeys",b)),this}};a.fn.menuHotkeys=function(b){var c=arguments,d="string"==typeof b,e=this.map(function(){if(void 0===b||"object"==typeof b)return i.init.call(a(this),b);if(d&&i[b])return i[b].apply(a(this),Array.prototype.slice.call(c,1));throw new Error("Calling method that is not part of the API")});return d?0===b.indexOf("get")?e[0]:e.toArray():e},c.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},textAcceptingInputTypes:["text","password","number","email","url","range","date","month","week","time","datetime","datetime-local","search","color","tel"],textInputTypes:/textarea|input|select/i,options:{filterInputAcceptingElements:!1,filterTextInputs:!1,filterContentEditable:!1}},c.each(["keydown","keyup","keypress"],function(){c.event.special[this]={add:b}})});